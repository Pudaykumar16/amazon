 we are going to deploy amazon app in aws ec2 using terraform as a infrastructure building tool and then we automate the whole process using the jenkins which allows us continuous integration and continuous deployment (ci-cd) and then we setup Promotheus and grafana for monitering

Pre-requisite
aws account
basics of terraform and jenkins
Let’s do it

before do anything →
open your terminal and make a separate folder for amazon →mkdir amazon
cd amazon
clone the github repo
git clone https://github.com/Aakibgithuber/Amazon-app-Deployment-using-terraform-and-jenkins.git
Completion steps →
Step 1 → Setup Terraform and configure aws on your local machine

Step 2 → Building a simple Infrastructure from code using terraform

Step 3 → Setup Sonarqube and jenkins

Step 4 → ci-cd pipeline

Step5 →Monitering via Prmotheus and grafana

Step 6 → Terraform Destroy

Step 1 → Setup Terraform and configure aws on your local machine
1. Setup Terraform
To install terraform copy and paste the below commands

sudo su
snap install terraform --classic
which terraform

2. Configure aws
create an IAM user
go to your aws account and type IAM

click on iam
3. click on user →create user


4. Give a name to your user and tick on provide user access to management console and then click on I want an IAM user option


5. choose a password for your user →click next

6. Attach the policies directly to your iam user → click next

note →I will provide the administrator accesss for now but we careful while attaching the policies on your workapce



review and create user
7. click on create user


8. download your password file if it is autogenerated otherwise it is your’s choice


9. Now click on your IAM user →security credentials


10. scroll down to access keys and create an access keys


11.choose aws cli from the options listed


12. click next and download you csv file for username and password


13. go to your terminal and type →aws configure

14. Now it is ask to your access key and secret key for this open your csv file and paste the access and secret key and remain everything default


15. Now you are ready to configure aws from your terminal

Step 2 → Building a simple Infrastructure from code using terraform
go to folder → cd JENKINS-TF
there are three files present main.tf, install_jenkins.sh , provider.tf
open the file →vim Main.tf

4. change this section → ami = # your ami id , key_name= #your key pair if any

Now run terraform commands →
main.tf includes userdata which links install_jenkins.sh file on which execution install jenkins,docker,trivy,and start the sonarqube container on port 9000
resource "aws_security_group" "Jenkins-sg" {
  name        = "Jenkins-Security Group"
  description = "Open 22,443,80,8080,9000"

  # Define a single ingress rule to allow traffic on all specified ports
  ingress = [
    for port in [22, 80, 443, 8080, 9000, 3000] : {
      description      = "TLS from VPC"
      from_port        = port
      to_port          = port
      protocol         = "tcp"
      cidr_blocks      = ["0.0.0.0/0"]
      ipv6_cidr_blocks = []
      prefix_list_ids  = []
      security_groups  = []
      self             = false
    }
  ]

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = {
    Name = "Jenkins-sg"
  }
}


resource "aws_instance" "web" {
  ami                    = "ami-0c7217cdde317cfec"
  instance_type          = "t2.large"
  key_name               = "my key"
  vpc_security_group_ids = [aws_security_group.Jenkins-sg.id]
  user_data              = templatefile("./install_jenkins.sh", {})

  tags = {
    Name = "amazon clone"
  }
  root_block_device {
    volume_size = 30
  }
}
terraform init
terraform validate
terraform plan
terraform apply --auto-approve


terraform init,validate and plan output

terraform apply
Go to your aws console and checkout the ec2 instances



ports that are listed in main.tf to be opened
Here we see amazon app instance is created by terraform with the given configuration

Step 3 → Setup Sonarqube and jenkins
1.Sonarqube →
copy the public ip of your machine

go to your browser and type →<publicip>:9000

sonarqube window open
2. iniatially username and password is admin


3. update your password


4. welcome window of Sonarqube

2. Jenkins →
on browser type →<public_ip>:8080

2. for this go to your ec2 and connect it


3. run the below commands

sudo su
cat /var/lib/jenkins/secrets/initialAdminPassword

output is your password and paste it to your jenkins

4. Install the suggested plugins



5. Setup your jenkins user



Welcome to jenkins dashboard
Step 4 → ci-cd pipeline
1. Install Plugins listed below
1 Eclipse Temurin Installer (Install without restart)

2 SonarQube Scanner (Install without restart)

3 NodeJs Plugin (Install Without restart)

4. owasp →The OWASP Plugin in Jenkins is like a “security assistant” that helps you find and fix security issues in your software. It uses the knowledge and guidelines from the Open Web Application Security Project (OWASP) to scan your web applications and provide suggestions on how to make them more secure. It’s a tool to ensure that your web applications are protected against common security threats and vulnerabilities.

5. Prometheus metrics →to moniter jenkins on grafana dashboard

6. Download all the docker realated plugins



2. add credentials of Sonarqube and Docker
1st we genrate a token for sonarqube to use in jenkins credentials as secret text

a. setup sonarqube credentials
go to http://publicip:9000
now enter your username and password
click on security →users →token →generate token
token_name==jenkins


4. copy the token and go to your jenkins →manage jenkins →credentials →global →add credentials

5. select secret text from dropdown

6. secret text ==your token , id =jenkins →click on create


b. setup projects in sonarqube for jenkins
go to your sonarqube server
click on projects
in the name field type Amazon
click on set up

click on setup

click on above option

click on generate


click on continue ….
Sonarqube project for jenkins is setup now

c. Setup docker credentials
go to your jenkins →manage jenkins →credentials →global →add credentials
provide your username and password of your dockerhub
id==docker


credentials for both are setup
3. Now we are going to setup tools for jenkins
go to manage jenkins → tools

a. add jdk
click on add jdk and select installer adoptium.net
choose jdk 17.0.8.1+1version and in name section enter jdk 17

b. add node js
click on add nodejs
enter node16 in name section
choose version nodejs 16.2.0

c. add docker →
click on add docker
name==docker
add installer ==download from docker.com

d. add sonarqube →
add sonar scanner
name ==sonar-scanner

e. add owasp dependency check →
Adding the Dependency-Check plugin in the “Tools” section of Jenkins allows you to perform automated security checks on the dependencies used by your application

add dependency check
name == DP-Check
from add installer select install from github.com

Step 4 →Configure global setting for sonarube
go to manage jenkins →Configure global setting →add sonarqube servers
name ==sonar-server
server_url==http://public_ip:9000
server authentication token == jenkins →it is created in sonarqube security configurations

4. let’s run the Pipeline →
go to new item →select pipeline →in the name section type amazon-pipeline
scroll down to the pipeline script and copy paste the following code
pipeline{
    agent any
    tools{
        jdk 'jdk17'
        nodejs 'node16'
    }
    environment {
        SCANNER_HOME=tool 'sonar-scanner'
    }
    stages {
        stage('clean workspace'){
            steps{
                cleanWs()
            }
        }
        stage('Checkout from Git'){
            steps{
                git branch: 'main', url: 'https://github.com/Aakibgithuber/Amazon-app-Deployment-using-terraform-and-jenkins.git'
            }
        }
        stage("Sonarqube Analysis "){
            steps{
                withSonarQubeEnv('sonar-server') {
                    sh ''' $SCANNER_HOME/bin/sonar-scanner -Dsonar.projectName=Amazon \
                    -Dsonar.projectKey=Amazon '''
                }
            }
        }
         stage("quality gate"){
           steps {
                script {
                    waitForQualityGate abortPipeline: false, credentialsId: 'jenkins' 
                }
            } 
        }
        stage('Install Dependencies') {
            steps {
                sh "npm install"
            }
        }
        stage('OWASP FS SCAN') {
            steps {
                dependencyCheck additionalArguments: '--scan ./ --disableYarnAudit --disableNodeAudit', odcInstallation: 'DP-Check'
                dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
            }
        }
        stage('TRIVY FS SCAN') {
            steps {
                sh "trivy fs . > trivyfs.txt"
            }
        }
        stage("Docker Build & Push"){
            steps{
                script{
                   withDockerRegistry(credentialsId: 'docker', toolName: 'docker'){   
                       sh "docker build -t amazon-clone ."
                       sh "docker tag amazon-clone aakibkhan1212/amazon-clone:latest "
                       sh "docker push aakibkhan1212/amazon-clone:latest "
                    }
                }
            }
        }
        stage("TRIVY"){
            steps{
                sh "trivy image aakibkhan1212/amazon-clone:latest > trivyimage.txt" 
            }
        }
        stage('Deploy to container'){
            steps{
                sh 'docker run -d --name amazon-clone -p 3000:3000 aakibkhan1212/amazon-clone:latest'
            }
        }
    }
}
3. click apply and save


4. click on build now → it will take about 10–15 min


sonarqube output
5. you could checkout the console output


wait for completion
6. owasp dependency check result


7. After a lot of error we did it

8. Now our docker image is build,push and deployed into a container and our app is live and running on port no. 3000

to check →http://<your-public-ip>:3000

Here’s is our amazon app
